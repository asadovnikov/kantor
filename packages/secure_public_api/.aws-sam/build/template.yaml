AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'packages

  Sample SAM Template for packages

  '
Globals:
  Function:
    Timeout: 3
    Tracing: Active
Resources:
  StagingCommittedTransactionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: tr_id
        AttributeType: S
      KeySchema:
      - AttributeName: tr_id
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TableName: StagingCommittedTransactions
  StagingLimitsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: Tier
        AttributeType: S
      KeySchema:
      - AttributeName: Tier
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TableName: StagingLimits
  StagingCustomersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: cst_id
        AttributeType: S
      - AttributeName: Email
        AttributeType: S
      KeySchema:
      - AttributeName: cst_id
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      GlobalSecondaryIndexes:
      - IndexName: Email-Firstname-Surname-PostalCode-index
        KeySchema:
        - AttributeName: Email
          KeyType: HASH
        Projection:
          ProjectionType: ALL
        ProvisionedThroughput:
          ReadCapacityUnits: '3'
          WriteCapacityUnits: '3'
      TableName: StagingCustomers
  ValidateTransactionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ValidateTransactionFunction
      Handler: index.handler
      Runtime: nodejs12.x
      Events:
        ValidateTransactionApi:
          Type: Api
          Properties:
            Path: /transaction/validate
            Method: post
  RegisterTransactionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RegisterTransactionFunction
      Handler: index.handler
      Runtime: nodejs12.x
      Environment:
        Variables:
          TABLE_NAME:
            Ref: StagingCommittedTransactionsTable
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: StagingCommittedTransactionsTable
      Events:
        RegisterTransactionApi:
          Type: Api
          Properties:
            Path: /transaction/register
            Method: post
  RegisterCustomerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RegisterCustomerFunction
      Handler: index.handler
      Runtime: nodejs12.x
      Environment:
        Variables:
          TABLE_NAME:
            Ref: StagingCustomersTable
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: StagingCustomersTable
  ResolveCustomerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ResolveCustomerFunction
      Handler: index.handler
      Runtime: nodejs12.x
      Environment:
        Variables:
          TABLE_NAME:
            Ref: StagingCustomersTable
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: StagingCustomersTable
  GetLimitsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetLimitsFunction
      Handler: index.handler
      Runtime: nodejs12.x
      Environment:
        Variables:
          TABLE_NAME:
            Ref: StagingLimitsTable
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: StagingLimitsTable
Outputs:
  ValidateTransactionApi:
    Description: API Gateway endpoint URL for Prod stage for Validate Transaction
      function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/transaction/validate/
  ValidateTransactionFunction:
    Description: Validate Transaction Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ValidateTransactionFunction
      - Arn
  ValidateTransactionFunctionIamRole:
    Description: Implicit IAM Role created for Validate Transaction function
    Value:
      Fn::GetAtt:
      - ValidateTransactionFunctionRole
      - Arn
  RegisterTransactionApi:
    Description: API Gateway endpoint URL for Prod stage for Register Transaction
      function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/transaction/register/
  RegisterTransactionFunction:
    Description: Register Transaction Lambda Function ARN
    Value:
      Fn::GetAtt:
      - RegisterTransactionFunction
      - Arn
  RegisterTransactionFunctionIamRole:
    Description: Implicit IAM Role created for Register Transaction function
    Value:
      Fn::GetAtt:
      - RegisterTransactionFunctionRole
      - Arn
  RegisterCustomerApi:
    Description: API Gateway endpoint URL for Prod stage for Register customer function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/customer/register/
  RegisterCustomerFunction:
    Description: Register Customer Lambda Function ARN
    Value:
      Fn::GetAtt:
      - RegisterCustomerFunction
      - Arn
  RegisterCustomerFunctionIamRole:
    Description: Implicit IAM Role created for Register Customer function
    Value:
      Fn::GetAtt:
      - RegisterCustomerFunctionRole
      - Arn
  GetLimitsApi:
    Description: API Gateway endpoint URL for Prod stage for Get Limits function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/limits
  GetLimitsFunction:
    Description: Get Limits Lambda Function ARN
    Value:
      Fn::GetAtt:
      - GetLimitsFunction
      - Arn
  GetLimitsFunctionIamRole:
    Description: Implicit IAM Role created for Get Limits function
    Value:
      Fn::GetAtt:
      - GetLimitsFunctionRole
      - Arn
  ResolveCustomerApi:
    Description: API Gateway endpoint URL for Prod stage for Resolve customer function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/customer/resolve/
  ResolveCustomerFunction:
    Description: Resolve Customer Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ResolveCustomerFunction
      - Arn
  ResolveCustomerFunctionIamRole:
    Description: Implicit IAM Role created for Resolve Customer function
    Value:
      Fn::GetAtt:
      - ResolveCustomerFunctionRole
      - Arn
  StagingCommittedTransactionsTable:
    Value:
      Fn::GetAtt:
      - StagingCommittedTransactionsTable
      - Arn
    Description: The ARN of StagingCommittedTransactions DynamoDB Table
  StagingCustomersTable:
    Value:
      Fn::GetAtt:
      - StagingCustomersTable
      - Arn
    Description: The ARN of StagingCustomers DynamoDB Table
  StagingLimitsTable:
    Value:
      Fn::GetAtt:
      - StagingLimitsTable
      - Arn
    Description: The ARN of StagingLimits DynamoDB Table
